name: Reusable PR Checks

on:
  workflow_call:
    inputs:
      node_version:
        description: "Node.js version to use for builds"
        required: false
        type: string
        default: "20"
      docker_registry:
        description: "Docker registry URL (e.g., registry.digitalocean.com/yourname)"
        required: true
        type: string
      workspaces:
        description: "Comma-separated list of workspaces to build (e.g., api,web)"
        required: false
        type: string
        default: "api,web"
      validate_k8s:
        description: "Whether to validate Kubernetes manifests"
        required: false
        type: boolean
        default: true
      validate_docker_compose:
        description: "Whether to validate docker-compose files"
        required: false
        type: boolean
        default: true
      next_public_api_base_url:
        description: "NEXT_PUBLIC_API_BASE_URL for web builds"
        required: false
        type: string
        default: ""
      next_public_keycloak_client_id:
        description: "NEXT_PUBLIC_KEYCLOAK_CLIENT_ID for web builds"
        required: false
        type: string
        default: ""
      next_public_keycloak_issuer:
        description: "NEXT_PUBLIC_KEYCLOAK_ISSUER for web builds"
        required: false
        type: string
        default: ""
      nextauth_url:
        description: "NEXTAUTH_URL for web builds"
        required: false
        type: string
        default: ""
      nextauth_secret:
        description: "NEXTAUTH_SECRET for web builds"
        required: false
        type: string
        default: "dummy-secret-for-build"
    secrets:
      DIGITALOCEAN_ACCESS_TOKEN:
        description: "DigitalOcean access token for container registry"
        required: true

permissions:
  contents: read
  pull-requests: read

env:
  DOCKER_REGISTRY: ${{ inputs.docker_registry }}

jobs:
  detect-changes:
    name: Detect Changed Services
    runs-on: ubuntu-latest
    outputs:
      api: ${{ steps.filter.outputs.api }}
      web: ${{ steps.filter.outputs.web }}
      any: ${{ steps.filter.outputs.any }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for file changes
        uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            api:
              - 'apps/api/**'
              - 'packages/**'
              - '.docker/Dockerfile.api'
            web:
              - 'apps/web/**'
              - 'packages/**'
              - '.docker/Dockerfile.web'
            any:
              - 'apps/**'
              - 'packages/**'
              - '.docker/**'

  build-api:
    name: Build API
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.api == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node_version }}
          cache: "npm"

      - name: Install dependencies
        env:
          # Prisma requires DATABASE_URL during generation
          DATABASE_URL: postgresql://dummy:dummy@localhost:5432/dummy
        run: npm ci

      - name: Build API
        env:
          DATABASE_URL: postgresql://dummy:dummy@localhost:5432/dummy
        run: npm run build --workspace=apps/api

      - name: Run API tests
        run: npm run test --workspace=apps/api || echo "No tests configured yet"

  build-web:
    name: Build Web
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.web == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node_version }}
          cache: "npm"

      - name: Install dependencies
        env:
          # Prisma requires DATABASE_URL during generation
          DATABASE_URL: postgresql://dummy:dummy@localhost:5432/dummy
        run: npm ci

      - name: Build Web (requires env vars)
        env:
          DATABASE_URL: postgresql://dummy:dummy@localhost:5432/dummy
          NEXT_PUBLIC_API_BASE_URL: ${{ inputs.next_public_api_base_url }}
          NEXT_PUBLIC_KEYCLOAK_CLIENT_ID: ${{ inputs.next_public_keycloak_client_id }}
          NEXT_PUBLIC_KEYCLOAK_ISSUER: ${{ inputs.next_public_keycloak_issuer }}
          NEXTAUTH_URL: ${{ inputs.nextauth_url }}
          NEXTAUTH_SECRET: ${{ inputs.nextauth_secret }}
        run: npm run build --workspace=apps/web

      - name: Run Web tests
        run: npm run test --workspace=apps/web || echo "No tests configured yet"

  build-and-push-docker-images:
    name: Build & Push Docker Image - ${{ matrix.service }}
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.any == 'true'
    strategy:
      matrix:
        service: [api, web]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Login to DigitalOcean Container Registry
        run: doctl registry login --expiry-seconds 1200

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: .docker/Dockerfile.${{ matrix.service }}
          push: true
          platforms: linux/amd64
          tags: |
            ${{ env.DOCKER_REGISTRY }}/datalove-${{ matrix.service }}:pr-${{ github.event.pull_request.number }}
            ${{ env.DOCKER_REGISTRY }}/datalove-${{ matrix.service }}:pr-${{ github.event.pull_request.number }}-${{ github.sha }}
          cache-from: type=registry,ref=${{ env.DOCKER_REGISTRY }}/datalove-${{ matrix.service }}:buildcache
          cache-to: type=registry,ref=${{ env.DOCKER_REGISTRY }}/datalove-${{ matrix.service }}:buildcache,mode=max
          build-args: |
            NODE_ENV=production
            NEXT_PUBLIC_API_BASE_URL=${{ matrix.service == 'web' && inputs.next_public_api_base_url || '' }}
            NEXT_PUBLIC_KEYCLOAK_CLIENT_ID=${{ matrix.service == 'web' && inputs.next_public_keycloak_client_id || '' }}
            NEXT_PUBLIC_KEYCLOAK_ISSUER=${{ matrix.service == 'web' && inputs.next_public_keycloak_issuer || '' }}

  validate-deployment:
    name: Validate Deployment Configuration
    runs-on: ubuntu-latest
    needs: [detect-changes, build-and-push-docker-images]
    if: needs.detect-changes.outputs.any == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate docker-compose for droplet
        if: inputs.validate_docker_compose
        run: |
          echo "âœ… Validating docker-compose configuration..."

          # Check if docker-compose file exists
          if [ ! -f "docker-compose.droplet.yaml" ]; then
            echo "âŒ docker-compose.droplet.yaml not found"
            exit 1
          fi

          # Validate docker-compose syntax (basic check)
          if command -v docker-compose &> /dev/null; then
            docker-compose -f docker-compose.droplet.yaml config > /dev/null
            echo "âœ… docker-compose syntax is valid"
          else
            echo "âš ï¸  docker-compose not available for validation, skipping syntax check"
          fi

      - name: Validate Kubernetes manifests
        if: inputs.validate_k8s
        run: |
          echo "âœ… Validating Kubernetes manifests..."

          # Check if kubernetes directory exists
          if [ ! -d "kubernetes/dev" ]; then
            echo "âš ï¸  kubernetes/dev directory not found, skipping K8s validation"
            exit 0
          fi

          # Validate YAML syntax for all manifests
          for file in kubernetes/dev/*.yaml; do
            if [ -f "$file" ]; then
              echo "Checking $file..."
              # Use Python to validate YAML syntax
              python3 -c "import yaml; yaml.safe_load(open('$file'))" || {
                echo "âŒ Invalid YAML in $file"
                exit 1
              }
            fi
          done

          echo "âœ… All Kubernetes manifests are valid YAML"

      - name: Simulate deployment (dry-run)
        run: |
          echo "## Deployment Dry-Run Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This PR would deploy the following:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.detect-changes.outputs.api }}" == "true" ]; then
            echo "- ðŸš€ **API**: \`${{ inputs.docker_registry }}/datalove-api:pr-${{ github.event.pull_request.number }}\`" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.detect-changes.outputs.web }}" == "true" ]; then
            echo "- ðŸš€ **Web**: \`${{ inputs.docker_registry }}/datalove-web:pr-${{ github.event.pull_request.number }}\`" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Deployment validation passed! This PR is ready to be deployed when merged." >> $GITHUB_STEP_SUMMARY

  pr-check-summary:
    name: PR Check Summary
    runs-on: ubuntu-latest
    needs:
      [
        detect-changes,
        build-api,
        build-web,
        build-and-push-docker-images,
        validate-deployment,
      ]
    if: always()
    steps:
      - name: Check build status
        run: |
          echo "## PR Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.detect-changes.outputs.api }}" == "true" ]; then
            if [ "${{ needs.build-api.result }}" == "success" ]; then
              echo "âœ… API build passed" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ API build failed" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          if [ "${{ needs.detect-changes.outputs.web }}" == "true" ]; then
            if [ "${{ needs.build-web.result }}" == "success" ]; then
              echo "âœ… Web build passed" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ Web build failed" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          if [ "${{ needs.build-and-push-docker-images.result }}" == "success" ] || [ "${{ needs.build-and-push-docker-images.result }}" == "skipped" ]; then
            echo "âœ… Docker images build & push passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Docker images build & push failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.validate-deployment.result }}" == "success" ]; then
            echo "âœ… Deployment validation passed" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.validate-deployment.result }}" == "skipped" ]; then
            echo "â­ï¸ Deployment validation skipped" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Deployment validation failed" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Fail if any build failed
        if: |
          (needs.detect-changes.outputs.api == 'true' && needs.build-api.result != 'success') ||
          (needs.detect-changes.outputs.web == 'true' && needs.build-web.result != 'success') ||
          (needs.build-and-push-docker-images.result != 'success' && needs.build-and-push-docker-images.result != 'skipped') ||
          (needs.validate-deployment.result != 'success' && needs.validate-deployment.result != 'skipped')
        run: |
          echo "One or more builds failed"
          exit 1
